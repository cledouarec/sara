---
id: "ADR-002"
type: architecture_decision_record
name: "Use MQTT for Device Communication"
description: >
  Decision to use MQTT protocol for device-to-hub communication instead of
  HTTP polling, WebSockets, or CoAP.
status: accepted
deciders:
  - "Smart Home Architecture Team"
justifies:
  - "SWDD-MQTT"
---

# Use MQTT for Device Communication

## Context

The smart home system requires reliable, low-latency communication between IoT
devices and the central hub. Devices have constrained resources (limited CPU,
memory, and power) and must maintain persistent connections for real-time
command delivery and status updates.

We evaluated several communication protocols:

- **HTTP Polling**: Simple but inefficient, high latency, battery drain
- **WebSockets**: Good for browser apps, but overhead for constrained devices
- **CoAP**: Designed for IoT but less mature ecosystem
- **MQTT**: Lightweight pub/sub protocol designed for IoT scenarios

## Decision

Use MQTT (Message Queuing Telemetry Transport) as the primary protocol for
device-to-hub communication.

## Rationale

1. **Low overhead**: MQTT has minimal packet size (2-byte header minimum),
   ideal for constrained devices and low-bandwidth networks

2. **Publish/Subscribe model**: Decouples devices from the hub, enabling
   flexible topic-based routing and easy addition of new device types

3. **QoS levels**: Built-in delivery guarantees (QoS 0/1/2) allow us to
   balance reliability vs. performance per message type

4. **Persistent sessions**: Devices can reconnect and receive missed messages,
   critical for intermittent connectivity

5. **Mature ecosystem**: Well-supported brokers (Mosquitto, EMQX), client
   libraries for embedded systems, and proven at scale

6. **Low latency**: Sub-100ms message delivery meets our <500ms command
   response requirement

## Consequences

### Positive

- Reliable message delivery with configurable guarantees
- Efficient use of device resources (battery, bandwidth)
- Easy to add new device types without protocol changes
- Strong community support and tooling

### Negative

- Requires running an MQTT broker on the hub
- Team needs MQTT expertise (training required)
- Topic namespace design is critical and hard to change later

### Risks

- Broker becomes single point of failure (mitigated by local broker on hub)
- Topic explosion with many devices (mitigated by hierarchical topic design)

## Alternatives Considered

### HTTP Polling

Rejected due to high latency (polling interval) and inefficient resource usage.
Devices would need to poll frequently for responsive commands, draining
batteries.

### WebSockets

Better suited for browser-based applications. Higher memory footprint and
complexity for embedded devices compared to MQTT.

### CoAP

Promising protocol for constrained devices, but less mature tooling and smaller
community. Could reconsider for future ultra-low-power devices.
